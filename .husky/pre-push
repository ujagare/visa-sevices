#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ White Wings Visa - Pre-push checks starting..."
echo "=================================================="

# Check if we're pushing to main branch
branch=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸ“ Current branch: $branch"

if [ "$branch" = "main" ]; then
    echo "âš ï¸  Pushing to main branch - Running comprehensive checks..."
    
    # Check for production readiness
    echo "ğŸ” Checking production readiness..."
    
    # Verify all forms have proper email configuration
    if grep -r "formsubmit.co/mrunal@whitewingsvisa.com" *.html > /dev/null; then
        echo "âœ… Form email configuration verified"
    else
        echo "âŒ Error: Form email configuration not found!"
        exit 1
    fi
    
    # Check for SEO essentials
    if [ -f "robots.txt" ] && [ -f "sitemap.xml" ]; then
        echo "âœ… SEO files present"
    else
        echo "âŒ Error: Missing SEO files (robots.txt or sitemap.xml)"
        exit 1
    fi
    
    # Check for security files
    if [ -f ".htaccess" ]; then
        echo "âœ… Security configuration present"
    else
        echo "âš ï¸  Warning: .htaccess file not found"
    fi
    
    # Verify enhanced form validation is included
    if [ -f "enhanced-form-validation.js" ]; then
        echo "âœ… Enhanced form validation present"
    else
        echo "âŒ Error: Enhanced form validation missing!"
        exit 1
    fi
    
    # Check for backup systems
    if [ -f "backup-email-system.js" ]; then
        echo "âœ… Backup email system present"
    else
        echo "âš ï¸  Warning: Backup email system not found"
    fi
    
    echo "ğŸ—ï¸  Running build process..."
    npm run build
    
    echo "ğŸ§ª Running final tests..."
    npm run test
    
    echo "=================================================="
    echo "âœ… Production readiness check completed!"
    echo "ğŸš€ Pushing to main branch - White Wings Visa"
    echo "ğŸ“§ Forms configured for: mrunal@whitewingsvisa.com"
    echo "ğŸŒ Repository: ujagare/visa-sevices"
    echo "=================================================="
else
    echo "ğŸ“ Pushing to development branch: $branch"
    echo "ğŸ§ª Running basic tests..."
    npm run test
    echo "âœ… Development push approved"
fi

echo "ğŸ‰ All pre-push checks passed!"
echo "ğŸš€ Deploying White Wings Visa website..."
